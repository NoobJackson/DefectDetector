<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO实时目标检测系统</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass {
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
        }
    </style>
    
    <style>
        /* 基础动画定义 */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* 加载动画 */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-bottom-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* 元素动画类 */
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.3); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 min-h-screen flex flex-col">
    <!-- 导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center">
                    <i class="fa fa-eye text-white text-xl"></i>
                </div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">
                    YOLO实时目标检测系统
                </h1>
            </div>
            
            <div class="flex items-center space-x-6">
                <div class="hidden md:flex items-center space-x-2">
                    <span id="connection-status-dot" class="w-3 h-3 rounded-full bg-amber-400 animate-pulse-slow"></span>
                    <span id="connection-status-text" class="text-sm font-medium">连接中...</span>
                </div>
                
                <button id="fullscreen-btn" class="p-2 rounded-full hover:bg-slate-100 transition-all relative overflow-hidden group">
                    <i class="fa fa-expand text-slate-600 group-hover:text-primary transition-colors"></i>
                    <span class="absolute inset-0 bg-primary/10 scale-0 group-hover:scale-100 rounded-full transition-transform origin-center duration-300"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 视频区域 -->
            <div class="lg:col-span-2 animate-slide-up" style="animation-delay: 100ms;">
                <div class="relative rounded-xl overflow-hidden shadow-lg bg-dark">
                    <!-- 视频Canvas -->
                    <canvas id="video-canvas" class="w-full h-auto"></canvas>
                    
                    <!-- 加载覆盖层 -->
                    <div id="loading-overlay" class="absolute inset-0 bg-dark/80 flex flex-col items-center justify-center z-10">
                        <div class="loader mb-4"></div>
                        <p class="text-white text-lg font-medium">正在连接视频流...</p>
                    </div>
                    
                    <!-- 错误覆盖层 -->
                    <div id="error-overlay" class="absolute inset-0 bg-dark/80 flex flex-col items-center justify-center z-10 hidden">
                        <div class="text-center p-6 max-w-md">
                            <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
                                <i class="fa fa-exclamation-triangle text-red-400 text-2xl"></i>
                            </div>
                            <h3 class="text-white text-xl font-semibold mb-2">连接失败</h3>
                            <p id="error-message" class="text-slate-300 mb-6">无法建立视频流连接，请检查网络或重试</p>
                            <button id="reconnect-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2.5 rounded-lg transition-all font-medium">
                                重新连接
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 视频信息层（固定宽度，防止排版跳动） -->
                <div class="mt-4 glass rounded-lg p-3 text-slate-800 text-sm flex flex-wrap gap-6">
                    <div class="flex items-center gap-2 w-36">
                        <i class="fa fa-tachometer text-primary w-5"></i>
                        <span>帧率: <span id="fps-counter" class="font-medium inline-block w-10 text-right">0</span> FPS</span>
                    </div>
                    <div class="flex items-center gap-2 w-36">
                        <i class="fa fa-clock-o text-primary w-5"></i>
                        <span>延迟: <span id="latency-counter" class="font-medium inline-block w-10 text-right">0</span> ms</span>
                    </div>
                    <div class="flex items-center gap-2 w-44">
                        <i class="fa fa-picture-o text-primary w-5"></i>
                        <span>分辨率: <span id="resolution-info" class="font-medium inline-block w-20 text-right">加载中...</span></span>
                    </div>
                </div>
                
                <!-- 检测统计卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-slate-500 text-sm">当前检测目标</p>
                                <h3 id="detection-count" class="text-3xl font-bold mt-1 text-primary">0</h3>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                                <i class="fa fa-object-group text-primary"></i>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-slate-500">处理耗时</span>
                                <span id="processing-time" class="font-medium">0 ms</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-slate-500 text-sm">模型信息</p>
                                <h3 id="model-name" class="text-2xl font-bold mt-1 text-accent">YOLO11n</h3>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-accent/10 flex items-center justify-center">
                                <i class="fa fa-cogs text-accent"></i>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-slate-500">置信度阈值</span>
                                <span id="confidence-value-display" class="font-medium">0.4</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-slate-500 text-sm">连接时长</p>
                                <h3 id="connection-time" class="text-3xl font-bold mt-1 text-secondary">0s</h3>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center">
                                <i class="fa fa-clock-o text-secondary"></i>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-100">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-slate-500">会话ID</span>
                                <span id="session-id-short" class="font-mono font-medium text-xs truncate max-w-[100px]"></span>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- 控制面板 -->
            <div class="lg:col-span-1 animate-slide-up" style="animation-delay: 200ms;">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden h-full">
                    <div class="bg-gradient-to-r from-primary to-accent p-5">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fa fa-sliders mr-2"></i>控制面板
                        </h2>
                    </div>
                    
                    <div class="p-5 space-y-6">
                        <!-- 置信度设置 -->
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label for="confidence-slider" class="font-medium">检测置信度</label>
                                <span id="confidence-value" class="bg-primary/10 text-primary px-3 py-1 rounded-full text-sm font-medium">0.4</span>
                            </div>
                            <input 
                                type="range" 
                                id="confidence-slider" 
                                min="0.1" 
                                max="0.9" 
                                step="0.05" 
                                value="0.4"
                                class="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-primary"
                            >
                        </div>
                        
                        <hr class="border-slate-100">
                        
                        <!-- 系统信息 -->
                        <div>
                            <h3 class="font-medium mb-3 flex items-center">
                                <i class="fa fa-info-circle mr-2 text-primary"></i>系统信息
                            </h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between p-2 hover:bg-slate-50 rounded-lg transition-colors">
                                    <span class="text-slate-500">会话ID:</span>
                                    <span id="session-id" class="font-mono bg-slate-100 px-2 py-0.5 rounded truncate max-w-[160px]"></span>
                                </div>
                                <div class="flex justify-between p-2 hover:bg-slate-50 rounded-lg transition-colors">
                                    <span class="text-slate-500">WebSocket状态:</span>
                                    <span id="ws-status" class="text-amber-500">连接中</span>
                                </div>
                                <div class="flex justify-between p-2 hover:bg-slate-50 rounded-lg transition-colors">
                                    <span class="text-slate-500">最后活动时间:</span>
                                    <span id="last-activity" class="text-slate-600">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="border-slate-100">
                        
                        <!-- 事件日志 -->
                        <div>
                            <h3 class="font-medium mb-3 flex items-center">
                                <i class="fa fa-history mr-2 text-primary"></i>事件日志
                            </h3>
                            <div id="event-log" class="bg-slate-50 rounded-lg p-3 h-40 overflow-y-auto text-sm space-y-2 text-slate-700">
                                <div class="animate-fade-in"><i class="fa fa-circle text-xs text-primary mr-2"></i>系统初始化中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-slate-400 py-6 mt-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm">© 2023 YOLO实时目标检测系统</p>
                </div>
                <div class="flex space-x-6 text-sm">
                    <a href="#" class="hover:text-white transition-colors">关于系统</a>
                    <a href="#" class="hover:text-white transition-colors">使用帮助</a>
                    <a href="#" class="hover:text-white transition-colors">技术文档</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // 全局变量
        let ws;
        let canvas, ctx;
        let sessionId = "{{ session_id }}";
        let lastFrameTime = 0;
        let fps = 0;
        let frameCount = 0;
        let lastSecond = 0;
        let connectionStartTime = null;
        let detectionCount = 0;
        let processingTime = 0;
        let confidenceDebounceTimer = null;
        let detectionHistory = [];
        
        // DOM元素
        const elements = {
            canvas: document.getElementById('video-canvas'),
            loadingOverlay: document.getElementById('loading-overlay'),
            errorOverlay: document.getElementById('error-overlay'),
            errorMessage: document.getElementById('error-message'),
            reconnectBtn: document.getElementById('reconnect-btn'),
            confidenceSlider: document.getElementById('confidence-slider'),
            confidenceValue: document.getElementById('confidence-value'),
            confidenceValueDisplay: document.getElementById('confidence-value-display'),
            fpsCounter: document.getElementById('fps-counter'),
            latencyCounter: document.getElementById('latency-counter'),
            resolutionInfo: document.getElementById('resolution-info'),
            detectionCount: document.getElementById('detection-count'),
            sessionId: document.getElementById('session-id'),
            sessionIdShort: document.getElementById('session-id-short'),
            connectionTime: document.getElementById('connection-time'),
            processingTime: document.getElementById('processing-time'),
            modelName: document.getElementById('model-name'),
            eventLog: document.getElementById('event-log'),
            connectionStatusDot: document.getElementById('connection-status-dot'),
            connectionStatusText: document.getElementById('connection-status-text'),
            wsStatus: document.getElementById('ws-status'),
            lastActivity: document.getElementById('last-activity'),
            fullscreenBtn: document.getElementById('fullscreen-btn')
        };
        
        // 初始化
        function init() {
            // 设置会话ID显示
            elements.sessionId.textContent = sessionId;
            elements.sessionIdShort.textContent = sessionId.substring(0, 8) + '...';
            
            // 初始化Canvas
            canvas = elements.canvas;
            ctx = canvas.getContext('2d');
            
            // 连接WebSocket
            connectWebSocket();
            
            // 事件监听
            elements.confidenceSlider.addEventListener('input', handleConfidenceDisplay);
            elements.confidenceSlider.addEventListener('change', handleConfidenceChange);
            elements.reconnectBtn.addEventListener('click', reconnect);
            elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // 启动FPS计数器
            setInterval(updateFPS, 1000);
            
            // 启动连接时间更新
            requestAnimationFrame(updateConnectionTime);
        }
        
        // 处理置信度显示更新
        function handleConfidenceDisplay() {
            const value = parseFloat(elements.confidenceSlider.value);
            elements.confidenceValue.textContent = value.toFixed(2);
            elements.confidenceValueDisplay.textContent = value.toFixed(2);
        }
        
        // 处理置信度实际变更
        function handleConfidenceChange() {
            const value = parseFloat(elements.confidenceSlider.value);
            
            // 添加视觉反馈
            elements.confidenceValue.classList.add('animate-pulse-slow');
            
            // 清除之前的计时器
            if (confidenceDebounceTimer) {
                clearTimeout(confidenceDebounceTimer);
            }
            
            // 设置防抖计时器
            confidenceDebounceTimer = setTimeout(() => {
                // 发送到服务器
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'set_confidence',
                        value: value
                    }));
                    logEvent(`设置检测置信度为 ${value.toFixed(2)}`);
                }
                
                // 移除更新状态
                elements.confidenceValue.classList.remove('animate-pulse-slow');
            }, 500);
        }
        
        // 连接WebSocket
        function connectWebSocket() {
            // 显示加载，隐藏错误
            elements.errorOverlay.classList.add('hidden');
            elements.loadingOverlay.classList.remove('hidden');
            
            // 更新状态
            updateStatus('connecting', '连接中...');
            
            // 构建WebSocket URL
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${sessionId}`;
            
            // 创建WebSocket连接
            ws = new WebSocket(wsUrl);
            
            // 连接打开时
            ws.onopen = function() {
                logEvent('已成功连接到视频流服务器');
                elements.loadingOverlay.classList.add('hidden');
                updateStatus('connected', '已连接');
                connectionStartTime = new Date();
                updateLastActivity();
            };
            
            // 收到消息时
            ws.onmessage = function(event) {
                updateLastActivity();
                
                // 处理二进制帧数据(视频帧)
                if (event.data instanceof Blob) {
                    handleFrameData(event.data);
                } 
                // 处理文本消息(控制信息)
                else {
                    try {
                        const message = JSON.parse(event.data);
                        handleControlMessage(message);
                    } catch (e) {
                        logEvent(`收到无效消息: ${event.data}`, 'error');
                    }
                }
            };
            
            // 连接关闭时
            ws.onclose = function(event) {
                logEvent(`连接已关闭 (代码: ${event.code})`, 'warning');
                elements.loadingOverlay.classList.add('hidden');
                
                if (event.code !== 1000) { // 1000是正常关闭代码
                    elements.errorOverlay.classList.remove('hidden');
                    elements.errorMessage.textContent = `连接已断开: ${event.reason || '未知原因'}`;
                    updateStatus('error', '已断开');
                }
            };
            
            // 连接错误时
            ws.onerror = function(error) {
                logEvent(`WebSocket错误: 无法建立连接`, 'error');
                elements.loadingOverlay.classList.add('hidden');
                elements.errorOverlay.classList.remove('hidden');
                elements.errorMessage.textContent = '连接发生错误，请检查网络或重试';
                updateStatus('error', '错误');
            };
        }
        
        // 处理视频帧数据
        function handleFrameData(blob) {
            const img = new Image();
            const startTime = performance.now();
            
            img.onload = function() {
                // 计算延迟
                const latency = Math.round(performance.now() - startTime);
                elements.latencyCounter.textContent = latency;
                
                // 更新Canvas尺寸
                if (canvas.width !== img.width || canvas.height !== img.height) {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    elements.resolutionInfo.textContent = `${img.width}x${img.height}`;
                }
                
                // 绘制图像
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // 更新帧率计数
                frameCount++;
                
                // 记录最后一帧时间
                lastFrameTime = Date.now();
            };
            
            img.src = URL.createObjectURL(blob);
        }
        
        // 处理控制消息
        function handleControlMessage(message) {
            switch (message.type) {
                case 'connected':
                    logEvent(message.message);
                    if (message.resolution) {
                        elements.resolutionInfo.textContent = message.resolution;
                    }
                    break;
                case 'warning':
                    logEvent(message.message, 'warning');
                    break;
                case 'error':
                    logEvent(message.message, 'error');
                    break;
                case 'confidence_updated':
                    logEvent(message.message);
                    break;
                case 'detection_count':
                    // 更新检测计数
                    detectionCount = message.count;
                    elements.detectionCount.textContent = detectionCount;
                    
                    // 记录历史数据
                    detectionHistory.push({
                        timestamp: message.timestamp,
                        count: detectionCount
                    });
                    
                    // 只保留最近30条数据
                    if (detectionHistory.length > 30) {
                        detectionHistory.shift();
                    }
                    break;
                case 'ack':
                    // 确认消息，无需特别处理
                    break;
                default:
                    logEvent(`收到消息: ${JSON.stringify(message)}`);
            }
        }
        
        // 重新连接
        function reconnect() {
            if (ws) {
                ws.close();
            }
            connectWebSocket();
        }
        
        // 更新FPS计数
        function updateFPS() {
            const now = Date.now();
            const elapsed = (now - lastSecond) / 1000;
            
            if (elapsed > 0) {
                fps = Math.round(frameCount / elapsed);
                elements.fpsCounter.textContent = fps;
            }
            
            frameCount = 0;
            lastSecond = now;
        }
        
        // 更新连接时间
        function updateConnectionTime() {
            if (!connectionStartTime) {
                requestAnimationFrame(updateConnectionTime);
                return;
            }
            
            const now = new Date();
            const diffMs = now - connectionStartTime;
            const seconds = Math.floor(diffMs / 1000) % 60;
            const minutes = Math.floor(diffMs / (1000 * 60)) % 60;
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            
            let timeStr = '';
            if (hours > 0) timeStr += `${hours}h `;
            if (minutes > 0 || hours > 0) timeStr += `${minutes}m `;
            timeStr += `${seconds}s`;
            
            elements.connectionTime.textContent = timeStr;
            
            // 继续更新
            requestAnimationFrame(updateConnectionTime);
        }
        
        // 更新最后活动时间
        function updateLastActivity() {
            const now = new Date();
            elements.lastActivity.textContent = now.toLocaleTimeString();
        }
        
        // 记录事件日志
        function logEvent(message, type = 'info') {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'animate-fade-in';
            
            let icon = '';
            switch (type) {
                case 'warning':
                    icon = '<i class="fa fa-exclamation-circle text-amber-500 mr-2"></i>';
                    break;
                case 'error':
                    icon = '<i class="fa fa-times-circle text-red-500 mr-2"></i>';
                    break;
                default:
                    icon = '<i class="fa fa-info-circle text-primary mr-2"></i>';
            }
            
            logEntry.innerHTML = `[${timeStr}] ${icon}${message}`;
            
            elements.eventLog.appendChild(logEntry);
            elements.eventLog.scrollTop = elements.eventLog.scrollHeight;
            
            // 限制日志条目数量
            if (elements.eventLog.children.length > 50) {
                elements.eventLog.removeChild(elements.eventLog.firstChild);
            }
        }
        
        // 更新连接状态
        function updateStatus(status, text) {
            // 移除所有状态类
            elements.connectionStatusDot.classList.remove('bg-amber-400', 'bg-green-500', 'bg-red-500');
            elements.connectionStatusDot.classList.remove('animate-pulse-slow');
            
            // 更新WebSocket状态文本
            elements.wsStatus.textContent = text;
            elements.wsStatus.className = '';
            
            // 添加新状态类
            switch (status) {
                case 'connecting':
                    elements.connectionStatusDot.classList.add('bg-amber-400', 'animate-pulse-slow');
                    elements.wsStatus.classList.add('text-amber-500');
                    break;
                case 'connected':
                    elements.connectionStatusDot.classList.add('bg-green-500');
                    elements.wsStatus.classList.add('text-green-500');
                    break;
                case 'error':
                    elements.connectionStatusDot.classList.add('bg-red-500', 'animate-pulse-slow');
                    elements.wsStatus.classList.add('text-red-500');
                    break;
            }
            
            elements.connectionStatusText.textContent = text;
        }
        
        // 切换全屏
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                if (canvas.requestFullscreen) canvas.requestFullscreen();
                else if (canvas.webkitRequestFullscreen) canvas.webkitRequestFullscreen();
                else if (canvas.msRequestFullscreen) canvas.msRequestFullscreen();
                elements.fullscreenBtn.innerHTML = '<i class="fa fa-compress text-slate-600 group-hover:text-primary transition-colors"></i><span class="absolute inset-0 bg-primary/10 scale-0 group-hover:scale-100 rounded-full transition-transform origin-center duration-300"></span>';
                logEvent('已进入全屏模式');
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
                elements.fullscreenBtn.innerHTML = '<i class="fa fa-expand text-slate-600 group-hover:text-primary transition-colors"></i><span class="absolute inset-0 bg-primary/10 scale-0 group-hover:scale-100 rounded-full transition-transform origin-center duration-300"></span>';
                logEvent('已退出全屏模式');
            }
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
        
        // 窗口关闭时关闭连接
        window.addEventListener('beforeunload', function() {
            if (ws) ws.close(1000, '页面关闭');
        });
    </script>
</body>
</html>